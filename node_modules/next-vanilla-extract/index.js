const {
  getClientStyleLoader,
} = require('next/dist/build/webpack/config/blocks/css/loaders/client');
const { VanillaExtractPlugin } = require('@vanilla-extract/webpack-plugin');

module.exports =
  (pluginOptions = {}) =>
  (nextConfig = {}) => {
    return Object.assign({}, nextConfig, {
      webpack(config, options) {
        config.plugins.push(
          new VanillaExtractPlugin(
            Object.assign({}, pluginOptions, {
              outputCSS: !options.isServer,
              outputLoaders: [
                !options.isServer
                  ? getClientStyleLoader({
                      assetPrefix: options.config.assetPrefix,
                      isDevelopment: options.dev,
                    })
                  : '',
              ],
            }),
          ),
        );

        if (typeof nextConfig.webpack === 'function') {
          return nextConfig.webpack(config, options);
        }

        return config;
      },
    });
  };
